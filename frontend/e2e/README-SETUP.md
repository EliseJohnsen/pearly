# E2E Test Setup Guide

This guide explains how to set up E2E tests with automatic test admin creation for both local development and CI/CD.

## How It Works

The test setup automatically creates a test admin user in your test database with a consistent API key. This ensures tests work in both local and CI environments without manual database setup.

### Setup Flow

1. **Global Setup** (`e2e/global-setup.ts`) runs before all tests
2. **Admin Setup** (`e2e/setup-test-admin.mts`) creates/updates test admin in database
3. **Tests Run** using the auto-generated API key from environment

## Local Setup

### 1. Configure Test Database

Edit `frontend/.env.test`:

```env
# Test Database URL (use different port/db than dev)
TEST_DB_URL=postgresql://test_user:test_password@localhost:5433/pearly_test

# Backend and frontend URLs
TEST_API_URL=http://localhost:8000
TEST_BASE_URL=http://localhost:3000

# API key is auto-generated - no need to set it manually!
# If you want to use a specific key, uncomment:
# TEST_ADMIN_API_KEY=your-custom-key
```

### 2. Start Services

```bash
# Terminal 1: Backend (connected to test database)
cd backend
set TEST_DB_URL=postgresql://test_user:test_password@localhost:5433/pearly_test
uvicorn app.main:app --reload

# Terminal 2: Frontend
cd frontend
npm run dev
```

### 3. Run Tests

```bash
cd frontend

# Tests will auto-create admin user on first run
npm run test:e2e:patterns

# Or manually setup admin first (optional)
npm run test:setup-admin
```

## Manual Admin Setup (Optional)

If you want to create the test admin before running tests:

```bash
cd frontend
npm run test:setup-admin
```

This will:
- ✅ Connect to test database
- ✅ Create `admin_users` table if it doesn't exist
- ✅ Create/update test admin user
- ✅ Display the API key to use

## CI/CD Setup (GitHub Actions)

### Environment Setup

The setup script works automatically in CI with these environment variables:

```yaml
env:
  TEST_DB_URL: postgresql://postgres:postgres@localhost:5432/pearly_test
  TEST_API_URL: http://localhost:8000
  TEST_BASE_URL: http://localhost:3000
  TEST_SECRET_KEY: test-secret-key
```

### Example GitHub Actions Workflow

```yaml
name: E2E Tests

on:
  pull_request:
  push:
    branches: [main, dev]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pearly_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Frontend Dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright Browsers
        working-directory: frontend
        run: npx playwright install chromium --with-deps

      - name: Install Backend Dependencies
        working-directory: backend
        run: |
          pip install -r requirements.txt

      - name: Run Database Migrations
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pearly_test
        run: alembic upgrade head

      - name: Start Backend
        working-directory: backend
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/pearly_test
          SECRET_KEY: test-secret-key
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Start Frontend
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: |
          npm run build
          npm run start &
          sleep 10

      - name: Run E2E Tests
        working-directory: frontend
        env:
          TEST_DB_URL: postgresql://postgres:postgres@localhost:5432/pearly_test
          TEST_API_URL: http://localhost:8000
          TEST_BASE_URL: http://localhost:3000
          TEST_SECRET_KEY: test-secret-key
          # API key will be auto-generated by global-setup.ts
        run: npm run test:e2e:patterns

      - name: Upload Test Results
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7
```

## How Admin Setup Works

### Setup Script (`e2e/setup-test-admin.mts`)

The script:
1. Connects to `TEST_DB_URL` database
2. Creates `admin_users` table if missing
3. Checks if test admin exists (`e2e-test-admin@perle.test`)
4. Creates or updates the admin with a consistent API key
5. Returns the API key for tests to use

### API Key Generation

- **With `TEST_ADMIN_API_KEY` set**: Uses your custom key
- **Without it**: Generates `e2e-test-api-key-{random}` for consistency

### Global Setup Integration

`global-setup.ts` automatically runs `setupTestAdmin()` before all tests:

```typescript
import { setupTestAdmin } from './setup-test-admin';

async function globalSetup(config: FullConfig) {
  // Auto-create test admin
  const apiKey = await setupTestAdmin();
  process.env.TEST_ADMIN_API_KEY = apiKey;

  // Continue with other setup...
}
```

## Troubleshooting

### Issue: "Database URL is required"
**Fix**: Set `TEST_DB_URL` in `.env.test` or environment

### Issue: "Failed to setup test admin"
**Causes**:
- Database not running
- Wrong credentials in `TEST_DB_URL`
- Database doesn't allow connections

**Fix**: Check database is running and credentials are correct:
```bash
psql postgresql://test_user:test_password@localhost:5433/pearly_test
```

### Issue: Tests still fail with auth error
**Causes**:
- Backend not connected to test database
- Backend using different database than tests

**Fix**: Ensure backend uses `TEST_DB_URL` when running tests:
```bash
set DATABASE_URL=postgresql://test_user:test_password@localhost:5433/pearly_test
uvicorn app.main:app --reload
```

### Issue: "admin_users table already exists with different schema"
**Fix**: Drop and recreate table:
```sql
DROP TABLE admin_users CASCADE;
-- Script will recreate it automatically
```

## Security Notes

- Test admin email: `e2e-test-admin@perle.test` (clearly marked as test)
- API keys are randomly generated per environment
- Use separate test database (never use production database!)
- Test database should be on different port/server than development

## Benefits

✅ **No manual setup** - Admin user created automatically
✅ **Works in CI** - No need to seed database beforehand
✅ **Consistent** - Same admin user across all test runs
✅ **Isolated** - Test database separate from dev/prod
✅ **Secure** - Random API keys, clearly marked test users
